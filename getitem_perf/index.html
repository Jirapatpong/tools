<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Log Analyzer V4.1 - Responsive & New SLA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --bg-color: #f8f9fa;
            --success: #1e8e3e;
            --info: #03a9f4;
            --normal: #ff9800;
            --warning: #f57c00;
            --danger: #d93025;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; }
        
        .header-upload { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; }
        .export-btn { 
            background: #1d6f42; color: white; border: none; padding: 8px 15px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;
        }

        /* ส่วนประกอบที่ต้องค้างอยู่ด้านบน */
        .sticky-top-area {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-bar { display: flex; border-bottom: 1px solid #eee; }
        .sla-bar { display: flex; border-bottom: 1px solid #eee; background: #fafafa; }
        .chart-bar { padding: 10px 20px; height: 180px; }

        .card-stat { text-align: center; flex: 1; padding: 10px 5px; border-right: 1px solid #eee; }
        .card-stat:last-child { border-right: none; }
        .card-stat small { display: block; color: #666; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }
        .card-stat strong { font-size: 1.2em; color: var(--primary-color); }

        .container { max-width: 100%; margin: 0 auto; padding: 0; }
        
        /* ตารางแบบตารางเดียวเพื่อความตรงของ Header */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        
        /* หัวตารางที่จะ Sticky ต่อจากส่วน Dashboard */
        thead th { 
            background: var(--primary-color); 
            color: white; 
            position: sticky; 
            z-index: 999;
            padding: 12px 15px;
            text-align: left;
            font-size: 0.9em;
        }

        td { padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .col-idx { width: 60px; text-align: center; }
        .col-req { width: 30%; }
        .col-res { width: 30%; }
        .col-dur { width: 20%; text-align: right; }

        .slow-warn { color: var(--warning); font-weight: bold; }
        .slow-danger { color: var(--danger); font-weight: bold; }
        
        #responseChart { height: 100% !important; width: 100% !important; }
    </style>
</head>
<body>

<div class="header-upload">
    <strong>Log Analyzer V4.1</strong> | 
    <input type="file" id="fileInput" accept=".log,.txt">
    <button id="exportBtn" class="export-btn" style="display:none;" onclick="exportToExcel()">Export to Excel</button>
</div>

<div id="mainContent" style="display:none;">
    <div class="sticky-top-area" id="stickyArea">
        <div class="stats-bar">
            <div class="card-stat"><small>เฉลี่ย (AVG)</small><strong id="avgVal">-</strong> ms</div>
            <div class="card-stat"><small>เร็วสุด (MIN)</small><strong id="minVal" style="color: var(--success);">-</strong> ms</div>
            <div class="card-stat"><small>ช้าสุด (MAX)</small><strong id="maxVal" style="color: var(--danger);">-</strong> ms</div>
            <div class="card-stat"><small>รายการทั้งหมด</small><strong id="totalCount">-</strong> ชุด</div>
        </div>
        <div class="sla-bar">
            <div class="card-stat"><small>< 1s</small><strong id="s1" style="color: var(--success);">-</strong></div>
            <div class="card-stat"><small>1 - 1.5s</small><strong id="s2" style="color: var(--info);">-</strong></div>
            <div class="card-stat"><small>1.5 - 2s</small><strong id="s3" style="color: #673ab7;">-</strong></div>
            <div class="card-stat"><small>2 - 3s</small><strong id="s4" style="color: var(--warning);">-</strong></div>
            <div class="card-stat"><small>> 3s</small><strong id="s5" style="color: var(--danger);">-</strong></div>
        </div>
        <div class="chart-bar">
            <canvas id="responseChart"></canvas>
        </div>
    </div>

    <div class="container">
        <table id="logTable">
            <thead>
                <tr id="tableHeaderRow">
                    <th class="col-idx">ชุดที่</th>
                    <th class="col-req">เวลา Request</th>
                    <th class="col-res">เวลา Response</th>
                    <th class="col-dur">Duration (ms)</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let myChart = null;
    let currentData = [];

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => processLog(event.target.result);
        reader.readAsText(file);
    });

    function cleanTimestamp(line) {
        const numbers = line.match(/\d+/g);
        if (numbers && numbers.length >= 7) {
            const [y, m, d, hh, mm, ss, ms] = numbers;
            return {
                dateObj: new Date(y, m-1, d, hh, mm, ss, ms),
                hour: hh,
                formatted: `${y}-${m}-${d} ${hh}:${mm}:${ss},${ms}`
            };
        }
        return null;
    }

    function processLog(text) {
        const lines = text.split(/\r?\n/);
        const pairs = [];
        let currentReq = null;

        lines.forEach(line => {
            const lower = line.toLowerCase();
            if (lower.includes("getitem request")) {
                currentReq = cleanTimestamp(line);
            } else if (lower.includes("getitem response") && currentReq) {
                const res = cleanTimestamp(line);
                if (res) {
                    const diff = res.dateObj - currentReq.dateObj;
                    if (diff >= 0) pairs.push({ reqTime: currentReq.formatted, resTime: res.formatted, hour: currentReq.hour, duration: diff });
                }
                currentReq = null;
            }
        });

        if (pairs.length > 0) {
            currentData = pairs;
            renderUI(pairs);
            document.getElementById('exportBtn').style.display = 'inline-block';
        } else {
            alert("ไม่พบข้อมูล Getitem ที่เข้าคู่กัน");
        }
    }

    function renderUI(data) {
        document.getElementById('mainContent').style.display = 'block';
        const durations = data.map(d => d.duration);
        const total = data.length;
        
        const min = Math.min(...durations);
        const max = Math.max(...durations);
        const avg = durations.reduce((a, b) => a + b, 0) / total;

        // Grouping Logic (5 Groups)
        const g1 = data.filter(d => d.duration < 1000).length;
        const g2 = data.filter(d => d.duration >= 1000 && d.duration < 1500).length;
        const g3 = data.filter(d => d.duration >= 1500 && d.duration < 2000).length;
        const g4 = data.filter(d => d.duration >= 2000 && d.duration < 3000).length;
        const g5 = data.filter(d => d.duration >= 3000).length;

        document.getElementById('avgVal').innerText = avg.toFixed(1);
        document.getElementById('minVal').innerText = min.toLocaleString();
        document.getElementById('maxVal').innerText = max.toLocaleString();
        document.getElementById('totalCount').innerText = total.toLocaleString();

        document.getElementById('s1').innerText = `${((g1/total)*100).toFixed(1)}% (${g1})`;
        document.getElementById('s2').innerText = `${((g2/total)*100).toFixed(1)}% (${g2})`;
        document.getElementById('s3').innerText = `${((g3/total)*100).toFixed(1)}% (${g3})`;
        document.getElementById('s4').innerText = `${((g4/total)*100).toFixed(1)}% (${g4})`;
        document.getElementById('s5').innerText = `${((g5/total)*100).toFixed(1)}% (${g5})`;

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.map((d, i) => {
            let cls = '';
            if(d.duration >= 3000) cls = 'slow-danger';
            else if(d.duration >= 2000) cls = 'slow-warn';
            return `<tr>
                <td class="col-idx">${i+1}</td>
                <td class="col-req">${d.reqTime}</td>
                <td class="col-res">${d.resTime}</td>
                <td class="col-dur ${cls}">${d.duration.toLocaleString()}</td>
            </tr>`;
        }).join('');

        updateChart(data);
        setTimeout(recalcSticky, 100);
    }

    function recalcSticky() {
        const stickyArea = document.getElementById('stickyArea');
        const ths = document.querySelectorAll('thead th');
        if (stickyArea) {
            const h = stickyArea.offsetHeight;
            ths.forEach(th => th.style.top = (h - 1) + 'px');
        }
    }

    function updateChart(data) {
        const hourly = {};
        data.forEach(d => {
            if (!hourly[d.hour]) hourly[d.hour] = { sum: 0, count: 0 };
            hourly[d.hour].sum += d.duration;
            hourly[d.hour].count++;
        });
        const labels = Object.keys(hourly).sort().map(h => h + ":00");
        const vals = Object.keys(hourly).sort().map(h => (hourly[h].sum / hourly[h].count).toFixed(1));
        const ctx = document.getElementById('responseChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ 
                    label: 'Latency (ms)', 
                    data: vals, 
                    borderColor: '#1a73e8', 
                    backgroundColor: 'rgba(26, 115, 232, 0.1)', 
                    fill: true, 
                    tension: 0.3 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function exportToExcel() {
        if (currentData.length === 0) return;
        const total = currentData.length;
        const avg = currentData.reduce((a,b)=>a+b.duration,0)/total;
        
        const summary = [
            ["Getitem Analysis Report (V4.1)"],
            ["Export Date", new Date().toLocaleString()],
            [],
            ["Overall Stats", "Value"],
            ["Total Requests", total],
            ["Average (ms)", avg.toFixed(2)],
            ["Min (ms)", Math.min(...currentData.map(d=>d.duration))],
            ["Max (ms)", Math.max(...currentData.map(d=>d.duration))],
            [],
            ["SLA Groups", "Percentage", "Count"],
            ["< 1000ms", ((currentData.filter(d=>d.duration<1000).length/total)*100).toFixed(1)+"%", currentData.filter(d=>d.duration<1000).length],
            ["1000 - 1500ms", ((currentData.filter(d=>d.duration>=1000 && d.duration<1500).length/total)*100).toFixed(1)+"%", currentData.filter(d=>d.duration>=1000 && d.duration<1500).length],
            ["1500 - 2000ms", ((currentData.filter(d=>d.duration>=1500 && d.duration<2000).length/total)*100).toFixed(1)+"%", currentData.filter(d=>d.duration>=1500 && d.duration<2000).length],
            ["2000 - 3000ms", ((currentData.filter(d=>d.duration>=2000 && d.duration<3000).length/total)*100).toFixed(1)+"%", currentData.filter(d=>d.duration>=2000 && d.duration<3000).length],
            ["> 3000ms", ((currentData.filter(d=>d.duration>=3000).length/total)*100).toFixed(1)+"%", currentData.filter(d=>d.duration>=3000).length],
            [],
            ["No.", "Request", "Response", "Duration (ms)"]
        ];

        currentData.forEach((d, i) => summary.push([i+1, d.reqTime, d.resTime, d.duration]));

        const ws = XLSX.utils.aoa_to_sheet(summary);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Log Analysis");
        XLSX.writeFile(wb, `Getitem_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    window.addEventListener('resize', () => {
        recalcSticky();
        if(myChart) myChart.resize();
    });
</script>

</body>
</html>
