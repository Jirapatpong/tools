<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Log Analyzer V4.0 - Dashboard & Excel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --bg-color: #f8f9fa;
            --success: #1e8e3e;
            --warning: #f9ab00;
            --danger: #d93025;
            --info: #17a2b8;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; }
        
        .header-upload { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; }
        .export-btn { 
            background: #1d6f42; color: white; border: none; padding: 8px 15px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;
        }
        .export-btn:hover { background: #145a32; }

        /* Sticky Area Wrapper */
        .sticky-wrapper {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--bg-color);
        }

        /* 1. แถบสถิติหลัก */
        .stats-bar {
            background: white;
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid #eee;
        }
        
        /* 2. แถบสัดส่วน % (SLA) */
        .sla-bar {
            background: #fff;
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            border-bottom: 2px solid var(--primary-color);
        }

        /* 3. กราฟ */
        .chart-bar {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 180px;
        }

        .card-stat { text-align: center; flex: 1; border-right: 1px solid #eee; }
        .card-stat:last-child { border-right: none; }
        .card-stat small { display: block; color: #666; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }
        .card-stat strong { font-size: 1.3em; color: var(--primary-color); }
        .sla-card strong { font-size: 1.1em; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        th, td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9em; }
        
        th { 
            background: var(--primary-color); color: white; 
            position: sticky; z-index: 999;
        }

        .col-idx { width: 70px; text-align: center; }
        .col-req { width: 35%; }
        .col-res { width: 35%; }
        .col-dur { width: 20%; text-align: right; }

        .slow-warn { color: var(--warning); font-weight: bold; }
        .slow-danger { color: var(--danger); font-weight: bold; }
        
        #responseChart { height: 100% !important; }
    </style>
</head>
<body>

<div class="header-upload">
    <strong>Log Analyzer V4.0</strong> | 
    <input type="file" id="fileInput" accept=".log,.txt">
    <button id="exportBtn" class="export-btn" style="display:none;" onclick="exportToExcel()">Export to Excel</button>
</div>

<div id="mainContent" style="display:none;">
    <div class="sticky-wrapper">
        <div class="stats-bar" id="statsBar">
            <div class="card-stat"><small>เฉลี่ย (AVG)</small><strong id="avgVal">-</strong> ms</div>
            <div class="card-stat"><small>เร็วสุด (MIN)</small><strong id="minVal" style="color: var(--success);">-</strong> ms</div>
            <div class="card-stat"><small>ช้าสุด (MAX)</small><strong id="maxVal" style="color: var(--danger);">-</strong> ms</div>
            <div class="card-stat"><small>รายการทั้งหมด</small><strong id="totalCount">-</strong> ชุด</div>
        </div>
        <div class="sla-bar" id="slaBar">
            <div class="card-stat sla-card"><small>< 1000ms</small><strong id="p1" style="color: var(--success);">-</strong></div>
            <div class="card-stat sla-card"><small>> 1000ms</small><strong id="p2" style="color: var(--info);">-</strong></div>
            <div class="card-stat sla-card"><small>> 2000ms</small><strong id="p3" style="color: var(--warning);">-</strong></div>
            <div class="card-stat sla-card"><small>> 3000ms</small><strong id="p4" style="color: var(--danger);">-</strong></div>
        </div>
        <div class="chart-bar" id="chartBar">
            <div id="chartContainer" style="height: 100%;">
                <canvas id="responseChart"></canvas>
            </div>
        </div>
        <table style="margin-bottom: 0;">
            <thead id="tableHeader">
                <tr>
                    <th class="col-idx">ชุดที่</th>
                    <th class="col-req">เวลา Request</th>
                    <th class="col-res">เวลา Response</th>
                    <th class="col-dur">Duration (ms)</th>
                </tr>
            </thead>
        </table>
    </div>

    <div class="container">
        <table id="logTable">
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let myChart = null;
    let currentData = [];

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => processLog(event.target.result);
        reader.readAsText(file);
    });

    function cleanTimestamp(line) {
        const numbers = line.match(/\d+/g);
        if (numbers && numbers.length >= 7) {
            const [y, m, d, hh, mm, ss, ms] = numbers;
            return {
                dateObj: new Date(y, m-1, d, hh, mm, ss, ms),
                hour: hh,
                formatted: `${y}-${m}-${d} ${hh}:${mm}:${ss},${ms}`
            };
        }
        return null;
    }

    function processLog(text) {
        const lines = text.split(/\r?\n/);
        const pairs = [];
        let currentReq = null;

        lines.forEach(line => {
            const lower = line.toLowerCase();
            if (lower.includes("getitem request")) {
                currentReq = cleanTimestamp(line);
            } else if (lower.includes("getitem response") && currentReq) {
                const res = cleanTimestamp(line);
                if (res) {
                    const diff = res.dateObj - currentReq.dateObj;
                    if (diff >= 0) pairs.push({ reqTime: currentReq.formatted, resTime: res.formatted, hour: currentReq.hour, duration: diff });
                }
                currentReq = null;
            }
        });

        if (pairs.length > 0) {
            currentData = pairs;
            renderUI(pairs);
            document.getElementById('exportBtn').style.display = 'inline-block';
        } else {
            alert("ไม่พบข้อมูลที่ต้องการ");
        }
    }

    function renderUI(data) {
        document.getElementById('mainContent').style.display = 'block';
        const durations = data.map(d => d.duration);
        const total = data.length;
        
        // Calculate Stats
        const min = Math.min(...durations);
        const max = Math.max(...durations);
        const avg = durations.reduce((a, b) => a + b, 0) / total;

        // Calculate Percentages
        const c1 = data.filter(d => d.duration < 1000).length;
        const c2 = data.filter(d => d.duration >= 1000 && d.duration < 2000).length;
        const c3 = data.filter(d => d.duration >= 2000 && d.duration < 3000).length;
        const c4 = data.filter(d => d.duration >= 3000).length;

        document.getElementById('avgVal').innerText = avg.toFixed(1);
        document.getElementById('minVal').innerText = min.toLocaleString();
        document.getElementById('maxVal').innerText = max.toLocaleString();
        document.getElementById('totalCount').innerText = total.toLocaleString();

        document.getElementById('p1').innerText = `${((c1/total)*100).toFixed(1)}% (${c1})`;
        document.getElementById('p2').innerText = `${((c2/total)*100).toFixed(1)}% (${c2})`;
        document.getElementById('p3').innerText = `${((c3/total)*100).toFixed(1)}% (${c3})`;
        document.getElementById('p4').innerText = `${((c4/total)*100).toFixed(1)}% (${c4})`;

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.map((d, i) => {
            let cls = '';
            if(d.duration >= 3000) cls = 'slow-danger';
            else if(d.duration >= 2000) cls = 'slow-warn';
            return `<tr>
                <td class="col-idx">${i+1}</td>
                <td class="col-req">${d.reqTime}</td>
                <td class="col-res">${d.resTime}</td>
                <td class="col-dur ${cls}">${d.duration.toLocaleString()}</td>
            </tr>`;
        }).join('');

        updateChart(data);
        adjustTableHeader();
    }

    function adjustTableHeader() {
        const wrapperHeight = document.querySelector('.sticky-wrapper').offsetHeight;
        const ths = document.querySelectorAll('th');
        const statsH = document.getElementById('statsBar').offsetHeight;
        const slaH = document.getElementById('slaBar').offsetHeight;
        const chartH = document.getElementById('chartBar').offsetHeight;
        // ตั้งค่า top ให้ th มาค้างอยู่ล่างสุดของพื้นที่ sticky
        ths.forEach(th => th.style.top = (statsH + slaH + chartH) + 'px');
    }

    function updateChart(data) {
        const hourly = {};
        data.forEach(d => {
            if (!hourly[d.hour]) hourly[d.hour] = { sum: 0, count: 0 };
            hourly[d.hour].sum += d.duration;
            hourly[d.hour].count++;
        });
        const labels = Object.keys(hourly).sort().map(h => h + ":00");
        const vals = Object.keys(hourly).sort().map(h => (hourly[h].sum / hourly[h].count).toFixed(1));
        const ctx = document.getElementById('responseChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Avg Latency (ms)', data: vals, borderColor: '#1a73e8', backgroundColor: 'rgba(26, 115, 232, 0.1)', fill: true, tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function exportToExcel() {
        if (currentData.length === 0) return;

        // 1. สร้าง Summary Data
        const avg = currentData.reduce((a,b)=>a+b.duration,0)/currentData.length;
        const summary = [
            ["Getitem Response Analysis Report"],
            ["Generated Date", new Date().toLocaleString()],
            [],
            ["Metric", "Value"],
            ["Total Requests", currentData.length],
            ["Average Duration (ms)", avg.toFixed(2)],
            ["Min Duration (ms)", Math.min(...currentData.map(d=>d.duration))],
            ["Max Duration (ms)", Math.max(...currentData.map(d=>d.duration))],
            [],
            ["SLA Breakdown", "Percentage", "Count"],
            ["< 1000ms", ((currentData.filter(d=>d.duration<1000).length/currentData.length)*100).toFixed(1)+"%", currentData.filter(d=>d.duration<1000).length],
            ["1000ms - 2000ms", ((currentData.filter(d=>d.duration>=1000 && d.duration<2000).length/currentData.length)*100).toFixed(1)+"%", currentData.filter(d=>d.duration>=1000 && d.duration<2000).length],
            ["2000ms - 3000ms", ((currentData.filter(d=>d.duration>=2000 && d.duration<3000).length/currentData.length)*100).toFixed(1)+"%", currentData.filter(d=>d.duration>=2000 && d.duration<3000).length],
            ["> 3000ms", ((currentData.filter(d=>d.duration>=3000).length/currentData.length)*100).toFixed(1)+"%", currentData.filter(d=>d.duration>=3000).length],
            [],
            ["Raw Data Details"],
            ["No.", "Request Timestamp", "Response Timestamp", "Duration (ms)"]
        ];

        // 2. เพิ่ม Raw Data
        currentData.forEach((d, i) => {
            summary.push([i+1, d.reqTime, d.resTime, d.duration]);
        });

        // 3. แปลงเป็น Workbook
        const ws = XLSX.utils.aoa_to_sheet(summary);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Analysis Report");

        // 4. ดาวน์โหลด
        XLSX.writeFile(wb, `Getitem_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    window.addEventListener('resize', adjustTableHeader);
</script>

</body>
</html>
