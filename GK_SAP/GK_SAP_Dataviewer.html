<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>GK Analyzer v21 - Master Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --sap: #e67e22; --gk: #2980b9; --bg: #ecf0f1; --border: #bdc3c7; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); overflow: hidden; }
        
        /* Navigation */
        nav { background: var(--primary); color: white; display: flex; padding: 0 15px; height: 45px; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .app-title { font-weight: bold; font-size: 15px; }
        .tabs { display: flex; gap: 5px; height: 100%; align-items: flex-end; }
        .tab { 
            padding: 10px 20px; cursor: pointer; background: #34495e; color: #bbb; 
            border-radius: 5px 5px 0 0; font-size: 12px; font-weight: 600; border-bottom: 3px solid transparent; 
        }
        .tab.active { background: #ecf0f1; color: #2c3e50; border-bottom: 3px solid var(--accent); }

        /* Main Content Area */
        #main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .view-section { display: none; flex: 1; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }

        /* Toolbar */
        .toolbar { padding: 8px 15px; background: white; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; }
        .btn-tool { padding: 6px 12px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 11px; border-radius: 3px; font-weight: 600; display:flex; align-items:center; gap:5px; transition: 0.2s; }
        .btn-tool:hover { background: #f9f9f9; border-color: #aaa; }
        .btn-green { background: var(--accent); color: white; border:none; }
        .btn-green:hover { background: #219150; }
        .btn-orange { background: var(--sap); color: white; border:none; }
        .btn-orange:hover { background: #d35400; }

        /* Table Styles */
        .table-wrapper { flex: 1; overflow: auto; background: white; padding: 0; }
        table { border-collapse: collapse; min-width: 100%; font-size: 11px; table-layout: fixed; width: 0; }
        
        th { 
            background: #f8f9fa; border: 1px solid #ddd; padding: 8px; text-align: left; 
            position: sticky; top: 0; z-index: 10; font-weight: 700; color: #444; 
            white-space: nowrap; overflow: hidden;
        }
        td { border: 1px solid #eee; padding: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
        tr:hover { background: #f0f8ff; }

        /* Split View Styles (Tab 2) */
        .split-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .divider { height: 6px; background: #ddd; cursor: row-resize; z-index: 50; flex-shrink: 0; }

        /* Helper Classes */
        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 5px; cursor: col-resize; }
        .resizer:hover { background: var(--accent); }
    </style>
</head>
<body>

<nav>
    <div class="app-title">üì¶ GK Analyzer v21</div>
    <div class="tabs">
        <div class="tab" onclick="switchMainTab('bi')">1. BI Overview</div>
        <div class="tab" onclick="switchMainTab('mapping')">2. Detail Mapping (Split)</div>
        <div class="tab active" onclick="switchMainTab('master')">3. Master Data (SAP &gt; GK)</div>
    </div>
</nav>

<div id="main-container">

    <div id="view-bi" class="view-section">
        <div class="toolbar">
            <b>BI Overview</b>
            <span style="color:#888; font-size:10px;">(Please load files in Tab 2 or 3)</span>
        </div>
        <div class="table-wrapper">
            <table id="biTable" style="width:100%"><thead><tr><th>Store / ID</th><th>Description</th><th>Source</th></tr></thead><tbody id="biBody"></tbody></table>
        </div>
    </div>

    <div id="view-mapping" class="view-section">
        <div class="split-container">
            <div class="panel" id="panel-top" style="flex:1;">
                <div class="toolbar">
                    <b style="color:#2980b9;">GK XML</b>
                    <button class="btn-tool" onclick="document.getElementById('xmlInput').click()">üìÇ Load XML Folder</button>
                    <input type="file" id="xmlInput" multiple webkitdirectory style="display:none">
                    <button class="btn-tool" onclick="APP.xml.data=[]; renderMapping('xml');">‚ùå Clear</button>
                </div>
                <div class="table-wrapper"><table id="xmlMapTable"><thead id="xmlMapHead"></thead><tbody id="xmlMapBody"></tbody></table></div>
            </div>
            
            <div class="divider" id="drag-divider"></div>

            <div class="panel" id="panel-bottom" style="flex:1;">
                <div class="toolbar">
                    <b style="color:#e67e22;">SAP JSON (Promo)</b>
                    <button class="btn-tool" onclick="document.getElementById('jsonInput').click()">üìÇ Load JSON File</button>
                    <input type="file" id="jsonInput" multiple accept=".json" style="display:none">
                    <button class="btn-tool" onclick="APP.json.data=[]; renderMapping('json');">‚ùå Clear</button>
                </div>
                <div class="table-wrapper"><table id="jsonMapTable"><thead id="jsonMapHead"></thead><tbody id="jsonMapBody"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="view-master" class="view-section active">
        <div class="toolbar">
            <b style="color:#27ae60;">SAP Master Data &gt; GK CSV</b>
            <button class="btn-tool btn-orange" onclick="document.getElementById('skuInput').click()">üìÇ 1. Load SAP Sku.json</button>
            <input type="file" id="skuInput" multiple accept=".json" style="display:none">
            <button class="btn-tool btn-green" onclick="exportMasterCSV()">‚¨á 2. Export GK CSV (;)</button>
            <span id="master-status" style="font-size:11px; color:#666; margin-left:auto;">Waiting for input...</span>
        </div>
        <div class="table-wrapper">
            <table id="masterTable">
                <thead id="masterHead"></thead>
                <tbody id="masterBody"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const APP = {
        xml: { data: [], columns: [] },
        json: { data: [], columns: [] },
        master: { data: [], columns: [
            "BusinessUnitId", "ItemId", "GTIN", "UomCode", "Name", "Description", 
            "TaxGroupId", "MerchandiseHierarchyGroupId", "Price", 
            "ShelfNumber", "ShelfLocation", "ActionPrice", 
            "ActionPriceEffectiveDate", "ActionPriceExpirationDate", 
            "SinglePiecesPerPackage", "PackagePiecesPerBox", 
            "PackageNetContent", "PackageBasicPriceContent"
        ]}
    };

    // --- INITIALIZATION ---
    document.getElementById('xmlInput').addEventListener('change', (e) => loadFiles(e.target.files, 'xml'));
    document.getElementById('jsonInput').addEventListener('change', (e) => loadFiles(e.target.files, 'json'));
    document.getElementById('skuInput').addEventListener('change', (e) => loadMasterFiles(e.target.files));
    
    // Render Master Header Immediately
    renderMasterHeader();

    function switchMainTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabId}`).classList.add('active');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- TAB 3: MASTER DATA LOGIC ---
    async function loadMasterFiles(files) {
        if (!files.length) return;
        APP.master.data = [];
        
        for (let file of Array.from(files)) {
            const text = await file.text();
            try {
                const json = JSON.parse(text);
                // Handle various SAP Wrappers
                let items = json.AssortmentSend_MT?.AssortmentList || 
                            json.RetailIncentiveERPStoreOfferReplicationBulkRequest_V1?.RetailIncentiveERPStoreOfferReplicationRequestMessage_V1 || 
                            [json];
                if (!Array.isArray(items)) items = [items];

                items.forEach(item => {
                    // Logic to extract UOMs. If multiple UOMs/EANs, create multiple rows? 
                    // Usually Master Data is 1 row per ItemId. Let's take the base UOM or list primary.
                    // Loop through UOMs to find EAN
                    
                    let uoms = item.UOM || [];
                    if(uoms.length === 0) uoms = [{}]; // Dummy for iteration

                    // Strategy: 1 Row per Item. Pick first valid EAN.
                    let baseUOM = uoms.find(u => u.MEINH === "EA" || u.MEINH === "PCE") || uoms[0];
                    let ean = baseUOM.EAN11 || (baseUOM.EAN ? baseUOM.EAN[0]?.EAN11 : "") || "";
                    
                    // Name
                    let name = item.MATTEXT?.find(t => t.SPRAS === "E")?.MAKTX || item.MATTEXT?.[0]?.MAKTX || "";
                    
                    // Item ID (Remove leading zeros)
                    let matnr = item.MATNR ? item.MATNR.replace(/^0+/, '') : "";

                    let row = {
                        "BusinessUnitId": item.LOCNR || "",
                        "ItemId": matnr,
                        "GTIN": ean,
                        "UomCode": baseUOM.MEINH || "",
                        "Name": name,
                        "Description": name, // Use same as name if desc missing
                        "TaxGroupId": "1", // Default
                        "MerchandiseHierarchyGroupId": item.MATKL || "",
                        "Price": "0", // Master usually has no price
                        "ShelfNumber": "",
                        "ShelfLocation": "",
                        "ActionPrice": "",
                        "ActionPriceEffectiveDate": "",
                        "ActionPriceExpirationDate": "",
                        "SinglePiecesPerPackage": "1",
                        "PackagePiecesPerBox": "1",
                        "PackageNetContent": "1",
                        "PackageBasicPriceContent": "1"
                    };
                    APP.master.data.push(row);
                });

            } catch(e) { console.error("Master Parse Error", e); alert("Invalid JSON format"); }
        }
        
        document.getElementById('master-status').textContent = `${APP.master.data.length} items ready to export`;
        renderMasterTable();
    }

    function renderMasterHeader() {
        const thead = document.getElementById('masterHead');
        thead.innerHTML = `<tr>${APP.master.columns.map(c => `<th style="width:120px;">${c}</th>`).join('')}</tr>`;
    }

    function renderMasterTable() {
        const tbody = document.getElementById('masterBody');
        tbody.innerHTML = APP.master.data.map(r => `
            <tr>${APP.master.columns.map(c => `<td>${r[c] || ''}</td>`).join('')}</tr>
        `).join('');
    }

    function exportMasterCSV() {
        if(APP.master.data.length === 0) { alert("No data to export!"); return; }
        
        // CSV Header (Semicolon separated)
        let csvContent = APP.master.columns.join(";") + "\n";
        
        // CSV Rows
        APP.master.data.forEach(row => {
            let rowString = APP.master.columns.map(c => {
                let val = row[c] || "";
                // Handle special characters if needed, mostly clean for Master
                return val;
            }).join(";");
            csvContent += rowString + "\n";
        });

        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "GK_MasterData_Import.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    // --- TAB 1 & 2 LOGIC (EXISTING) ---
    // (Reuse logic from previous version for processFiles, flatten, etc. condensed below)
    async function loadFiles(files, type) {
        // ... (Logic from v20 for XML/JSON Mapping) ...
        // For brevity in this combined version, I'll include basic loaders
        // In real usage, keep the v20 parsing logic here.
        if (!files.length) return;
        APP[type].data = [];
        let keys = new Set();
        for(let f of Array.from(files)) {
            let txt = await f.text();
            let r = {"FileName":f.name};
            if(type==='xml'){
                 const xml = new DOMParser().parseFromString(txt, "text/xml");
                 flattenSimple(xml.documentElement, r, "");
                 APP[type].data.push(r);
            } else {
                 const j = JSON.parse(txt);
                 let arr = j.RetailIncentiveERPStoreOfferReplicationBulkRequest_V1?.RetailIncentiveERPStoreOfferReplicationRequestMessage_V1 || [j];
                 if(!Array.isArray(arr)) arr=[arr];
                 arr.forEach(i => { let sr={"FileName":f.name}; flattenSimple(i, sr, ""); APP[type].data.push(sr); });
            }
        }
        APP[type].data.forEach(x => Object.keys(x).forEach(k=>keys.add(k)));
        APP[type].columns = Array.from(keys);
        renderMapping(type);
    }
    
    function flattenSimple(obj, res, p) {
        // ... Simplified flattener for Tab 2 demo ...
        for(let k in obj) {
            if(typeof obj[k]!=='object') res[p?p+'.'+k:k] = obj[k];
            else flattenSimple(obj[k], res, p?p+'.'+k:k);
        }
        if(obj.nodeType) { // XML
           if(obj.children.length===0) res[p+obj.nodeName] = obj.textContent;
           else Array.from(obj.children).forEach(c=>flattenSimple(c, res, p));
        }
    }
    
    function renderMapping(type) {
        const th = document.getElementById(`${type}MapHead`);
        const tb = document.getElementById(`${type}MapBody`);
        th.innerHTML = `<tr>${APP[type].columns.map(k=>`<th style="width:100px;">${k}</th>`).join('')}</tr>`;
        tb.innerHTML = APP[type].data.map(r=>`<tr>${APP[type].columns.map(k=>`<td>${r[k]||''}</td>`).join('')}</tr>`).join('');
    }

    // Splitter Logic
    const divider = document.getElementById('drag-divider');
    divider.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const startY = e.clientY;
        const startH = document.getElementById('panel-top').offsetHeight;
        const mm = (ev) => document.getElementById('panel-top').style.flex = `0 0 ${Math.max(50, startH + (ev.clientY - startY))}px`;
        const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); };
        document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
    });
</script>
</body>
</html>
