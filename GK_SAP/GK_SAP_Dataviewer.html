<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>GK Analyzer v28 - True Mirror</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --sap: #e67e22; --gk: #8e44ad; --bg: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); overflow: hidden; }
        nav { background: var(--primary); color: white; display: flex; padding: 0 15px; height: 45px; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .tabs { display: flex; gap: 5px; height: 100%; align-items: flex-end; }
        .tab { padding: 10px 20px; cursor: pointer; background: #34495e; color: #bbb; border-radius: 5px 5px 0 0; font-size: 12px; }
        .tab.active { background: #ecf0f1; color: #2c3e50; border-bottom: 3px solid var(--accent); }
        .split-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; }
        .divider { height: 8px; background: #ddd; cursor: row-resize; z-index: 50; }
        .toolbar { padding: 6px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; }
        .btn-green { background: var(--accent); color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; font-weight: bold; }
        .table-wrapper { flex: 1; overflow: auto; }
        table { border-collapse: collapse; min-width: 100%; font-size: 11px; table-layout: fixed; }
        th { background: #f4f4f4; border: 1px solid #ddd; padding: 8px; text-align: left; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        td { border: 1px solid #eee; padding: 4px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mapped-badge { font-size: 9px; background: #dff0d8; color: #3c763d; padding: 1px 3px; border-radius: 3px; }
    </style>
</head>
<body>

<nav>
    <div style="font-weight:bold;">ðŸ“¦ GK Analyzer v28</div>
    <div class="tabs">
        <div class="tab" onclick="switchTab('bi')">1. BI Overview</div>
        <div class="tab" onclick="switchTab('promo')">2. Promo Compare</div>
        <div class="tab active" onclick="switchTab('master')">3. Master (True Mirror)</div>
    </div>
</nav>

<div id="main-container" style="flex:1; display:flex; flex-direction:column;">
    <div id="view-master" style="display:flex; flex-direction:column; flex:1;">
        <div class="split-container">
            <div class="panel" id="panel-top">
                <div class="toolbar">
                    <b style="color:var(--sap);">ðŸŸ§ SAP SKU JSON</b>
                    <input type="file" id="skuInput" multiple accept=".json">
                </div>
                <div class="table-wrapper"><table id="sapTable"><thead></thead><tbody></tbody></table></div>
            </div>
            <div class="divider" id="divider"></div>
            <div class="panel" id="panel-bottom">
                <div class="toolbar">
                    <b style="color:var(--gk);">ðŸŸª GK Mirror Target (Based on Haribo.xml)</b>
                    <button class="btn-green" onclick="exportTrueMirrorXML()">â¬‡ Export True Mirror XML</button>
                </div>
                <div class="table-wrapper"><table id="gkTable"><thead></thead><tbody></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<script>
    // à¸ªà¸£à¸¸à¸› Field à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¸žà¸šà¹ƒà¸™ Haribo XML à¸•à¸²à¸¡à¸¥à¸³à¸”à¸±à¸šà¸ˆà¸£à¸´à¸‡
    const MIRROR_FIELDS = [
        "BusinessUnitID", "ItemID", "BonText", "Description", "TaxGroupID", "UpdateStockFlag", 
        "BaseUOMCode", "MinimumShelfLifeDayCount", "ClassCode", "TaxExemptCode", "WarrantyPeriod", 
        "LabelType", "ItemUsageTypeCode", "MerchandiseHierarchyGroupID", "RegularSalesUnitPrice", "MainPOSItemID", "PriceTypeCode"
    ];

    let APP_DATA = { sap: [], gk: [] };

    document.getElementById('skuInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        APP_DATA.sap = [];
        for (let f of files) {
            const json = JSON.parse(await f.text());
            let list = json.AssortmentSend_MT?.AssortmentList || [json];
            if(!Array.isArray(list)) list = [list];
            list.forEach(item => {
                let flat = { MATNR: item.MATNR?.replace(/^0+/, ''), LOCNR: item.LOCNR };
                // Extract Price & EAN from SAP Structure
                let u = item.UOM?.find(x => x.MEINH === 'EA') || item.UOM?.[0];
                flat.Price = u?.CONDITION?.find(c => c.KSCHL === 'VKP1')?.CONDITION_VALUE?.[0]?.KWERT || "0";
                flat.EAN = u?.EAN11 || u?.EAN?.[0]?.EAN11 || "";
                flat.MAKTX = item.MATTEXT?.find(t => t.SPRAS === 'E')?.MAKTX || item.MATTEXT?.[0]?.MAKTX || "";
                flat.MATKL = item.MATKL;
                flat.MEINH = u?.MEINH || "EA";
                APP_DATA.sap.push(flat);
            });
        }
        renderTables();
    });

    function renderTables() {
        const sapT = document.getElementById('sapTable');
        const gkT = document.getElementById('gkTable');
        
        // Render GK Table (Target)
        gkT.querySelector('thead').innerHTML = `<tr>${MIRROR_FIELDS.map(f => `<th>${f}</th>`).join('')}</tr>`;
        gkT.querySelector('tbody').innerHTML = APP_DATA.sap.map(s => `
            <tr>
                <td>${s.LOCNR}</td><td>${s.MATNR}</td><td>${s.MAKTX}</td><td>${s.MAKTX}</td>
                <td>A1</td><td>true</td><td>${s.MEINH}</td><td>0</td><td>HAWA</td><td>00</td>
                <td>0</td><td>HAWA</td><td>00</td><td>${s.MATKL}</td><td>${s.Price}</td>
                <td>${s.EAN}</td><td>RP</td>
            </tr>
        `).join('');
    }

    function exportTrueMirrorXML() {
        if(!APP_DATA.sap.length) return alert("No data");
        
        let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
        xml += `<ItemList xmlns:importDomain="http://www.gk-software.com/storeweaver/master_data/import_domain/2.2.0" xsi:schemaLocation="http://www.gk-software.com/storeweaver/master_data/item/3.4.0 xsd/masterData_Item.xsd" NumberOfItems="${APP_DATA.sap.length}" xmlns="http://www.gk-software.com/storeweaver/master_data/item/3.4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n`;

        APP_DATA.sap.forEach(s => {
            xml += `\t<Item ChangeType="DIRECT">\n`;
            xml += `\t\t<BusinessUnitAssignment>\n\t\t\t<BusinessUnitID>${s.LOCNR}</BusinessUnitID>\n\t\t</BusinessUnitAssignment>\n`;
            xml += `\t\t<ItemID>${s.MATNR}</ItemID>\n`;
            xml += `\t\t<BonText>${s.MAKTX}</BonText>\n`;
            xml += `\t\t<Description>${s.MAKTX}</Description>\n`;
            xml += `\t\t<TaxGroupID>A1</TaxGroupID>\n`;
            xml += `\t\t<UpdateStockFlag>true</UpdateStockFlag>\n`;
            xml += `\t\t<BaseUOMCode>${s.MEINH}</BaseUOMCode>\n`;
            xml += `\t\t<MinimumShelfLifeDayCount>0</MinimumShelfLifeDayCount>\n`;
            xml += `\t\t<ClassCode>HAWA</ClassCode>\n`;
            xml += `\t\t<TaxExemptCode>00</TaxExemptCode>\n`;
            xml += `\t\t<WarrantyPeriod>0</WarrantyPeriod>\n`;
            xml += `\t\t<LabelType>HAWA</LabelType>\n`;
            xml += `\t\t<ItemUsageTypeCode>00</ItemUsageTypeCode>\n`;
            
            // --- UOMItem Section (Strict Order) ---
            xml += `\t\t<UOMItem>\n`;
            xml += `\t\t\t<UOMCode>${s.MEINH}</UOMCode>\n`;
            xml += `\t\t\t<MainPOSItemID>${s.EAN}</MainPOSItemID>\n`;
            xml += `\t\t\t<StatusCode>01</StatusCode>\n`;
            xml += `\t\t\t<QuantityInputTypeCode>1</QuantityInputTypeCode>\n`;
            xml += `\t\t\t<QuantityInputMethod>1</QuantityInputMethod>\n`;
            xml += `\t\t\t<Price>\n\t\t\t\t<Price>${s.Price}</Price>\n\t\t\t\t<PriceTypeCode>RP</PriceTypeCode>\n\t\t\t</Price>\n`;
            xml += `\t\t</UOMItem>\n`;

            xml += `\t\t<MerchandiseHierarchyGroupAssignment>\n\t\t\t<MerchandiseHierarchyGroupID>${s.MATKL}</MerchandiseHierarchyGroupID>\n\t\t</MerchandiseHierarchyGroupAssignment>\n`;
            xml += `\t\t<RegularSalesUnitPrice>${s.Price}</RegularSalesUnitPrice>\n`;
            xml += `\t</Item>\n`;
        });

        xml += `</ItemList>`;
        
        const blob = new Blob([xml], { type: 'text/xml' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "ItemMasterData_TrueMirror.xml";
        a.click();
    }

    function switchTab(id) { /* logic as before */ }
</script>
</body>
</html>
